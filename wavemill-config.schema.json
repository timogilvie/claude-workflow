{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Wavemill configuration",
  "description": "Per-repo (.wavemill-config.json) or user-level (~/.wavemill/config.json) config. All fields are optional; env vars override everything.",
  "type": "object",
  "properties": {
    "linear": {
      "type": "object",
      "properties": {
        "project": {
          "type": "string",
          "description": "Linear project name for backlog queries. Empty string means all projects."
        }
      }
    },
    "mill": {
      "type": "object",
      "description": "Settings for the 'wavemill mill' command.",
      "properties": {
        "session": {
          "type": "string",
          "default": "wavemill",
          "description": "Tmux session name."
        },
        "maxParallel": {
          "type": "integer",
          "default": 3,
          "minimum": 1,
          "description": "Number of parallel agent workers."
        },
        "pollSeconds": {
          "type": "integer",
          "default": 10,
          "minimum": 1,
          "description": "Seconds between PR status checks."
        },
        "baseBranch": {
          "type": "string",
          "default": "main",
          "description": "Base branch for worktrees and PR targets."
        },
        "worktreeRoot": {
          "type": "string",
          "default": "../worktrees",
          "description": "Directory for git worktrees. Relative paths resolve against the repo root."
        },
        "agentCmd": {
          "type": "string",
          "default": "claude",
          "description": "Agent CLI to use. Built-in support for 'claude' and 'codex'. Other CLIs work via generic tmux passthrough. Can be overridden with --agent flag or AGENT_CMD env var.",
          "examples": ["claude", "codex"]
        },
        "requireConfirm": {
          "type": "boolean",
          "default": true,
          "description": "Whether to prompt for confirmation before launching tasks."
        },
        "planningMode": {
          "type": "string",
          "enum": ["skip", "interactive"],
          "default": "skip",
          "description": "How to handle the planning phase. 'interactive' launches Claude in tmux for user-guided planning before implementation. 'skip' goes straight to autonomous implementation (current default behavior)."
        },
        "maxRetries": {
          "type": "integer",
          "default": 3,
          "minimum": 1,
          "description": "Max retry attempts for failed API calls."
        },
        "retryDelay": {
          "type": "integer",
          "default": 2,
          "minimum": 1,
          "description": "Initial retry delay in seconds (doubles on each retry)."
        },
        "setupCommand": {
          "type": "string",
          "default": "",
          "description": "Shell command to run in each new worktree before agent launch (e.g., 'npm install'). Skipped when resuming an existing worktree.",
          "examples": ["npm install", "pnpm install", "pip install -r requirements.txt"]
        }
      }
    },
    "expand": {
      "type": "object",
      "description": "Settings for the 'wavemill expand' command.",
      "properties": {
        "maxSelect": {
          "type": "integer",
          "default": 3,
          "minimum": 1,
          "description": "Maximum issues that can be selected for expansion."
        },
        "maxDisplay": {
          "type": "integer",
          "default": 9,
          "minimum": 1,
          "description": "Maximum candidate issues shown in the selection list."
        }
      }
    },
    "plan": {
      "type": "object",
      "description": "Settings for the 'wavemill plan' command.",
      "properties": {
        "maxDisplay": {
          "type": "integer",
          "default": 9,
          "minimum": 1,
          "description": "Maximum initiatives shown in the selection list."
        },
        "research": {
          "type": "boolean",
          "default": false,
          "description": "When true, always run the research phase before plan decomposition. Can be overridden by the --research CLI flag."
        },
        "model": {
          "type": "string",
          "default": "claude-opus-4-6",
          "description": "Claude model to use for plan decomposition and research. Can be overridden with PLAN_MODEL env var."
        }
      }
    },
    "eval": {
      "type": "object",
      "description": "Settings for the 'wavemill eval' command.",
      "properties": {
        "aggregation": {
          "type": "object",
          "description": "Cross-repo eval aggregation settings for training the DSPy-optimized model router.",
          "properties": {
            "repos": {
              "type": "array",
              "items": { "type": "string" },
              "default": [],
              "description": "Absolute paths to repository directories to aggregate evals from."
            },
            "outputPath": {
              "type": "string",
              "default": ".wavemill/evals/aggregated-evals.jsonl",
              "description": "Output path for the aggregated eval file, relative to repo root."
            }
          },
          "additionalProperties": false
        },
        "evalsDir": {
          "type": "string",
          "default": ".wavemill/evals",
          "description": "Directory for persisting eval result JSONL files. Relative paths resolve against the repo root."
        },
        "judge": {
          "type": "object",
          "description": "LLM judge configuration for eval scoring.",
          "properties": {
            "model": {
              "type": "string",
              "default": "claude-sonnet-4-5-20250929",
              "minLength": 1,
              "description": "Model ID for the eval judge (e.g. 'claude-sonnet-4-5-20250929', 'claude-haiku-4-5-20251001')."
            },
            "provider": {
              "type": "string",
              "default": "anthropic",
              "enum": ["anthropic"],
              "description": "LLM provider for the eval judge. Currently only 'anthropic' is supported."
            }
          },
          "additionalProperties": false
        },
        "pricing": {
          "type": "object",
          "description": "Per-model pricing table for cost estimation. Keys are model identifiers, values specify cost per million tokens.",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "inputCostPerMTok": {
                "type": "number",
                "minimum": 0,
                "description": "Cost in USD per million input tokens."
              },
              "outputCostPerMTok": {
                "type": "number",
                "minimum": 0,
                "description": "Cost in USD per million output tokens."
              },
              "cacheWriteCostPerMTok": {
                "type": "number",
                "minimum": 0,
                "description": "Cost in USD per million cache creation (write) input tokens. Defaults to 1.25x inputCostPerMTok."
              },
              "cacheReadCostPerMTok": {
                "type": "number",
                "minimum": 0,
                "description": "Cost in USD per million cache read input tokens. Defaults to 0.1x inputCostPerMTok."
              }
            },
            "required": ["inputCostPerMTok", "outputCostPerMTok"],
            "additionalProperties": false
          }
        },
        "interventionPenalties": {
          "type": "object",
          "description": "Penalty weights per intervention type. Each value is the score penalty (0-1) applied per occurrence of that intervention type.",
          "properties": {
            "reviewComment": {
              "type": "number",
              "default": 0.05,
              "minimum": 0,
              "maximum": 1,
              "description": "Penalty per PR review comment requesting changes."
            },
            "postPrCommit": {
              "type": "number",
              "default": 0.08,
              "minimum": 0,
              "maximum": 1,
              "description": "Penalty per commit made after the initial PR creation."
            },
            "manualEdit": {
              "type": "number",
              "default": 0.10,
              "minimum": 0,
              "maximum": 1,
              "description": "Penalty per manual file edit (commit not attributed to the agent)."
            },
            "testFix": {
              "type": "number",
              "default": 0.06,
              "minimum": 0,
              "maximum": 1,
              "description": "Penalty per interactive test fix detected in commit messages."
            },
            "sessionRedirect": {
              "type": "number",
              "default": 0.12,
              "minimum": 0,
              "maximum": 1,
              "description": "Penalty per user redirection detected in the Claude session transcript (user sent a message correcting the agent mid-session)."
            }
          },
          "additionalProperties": false
        }
      }
    },
    "autoEval": {
      "type": "boolean",
      "default": false,
      "description": "When true, automatically run eval after workflow/bugfix command completion (PR creation). Eval failures are logged as warnings and never fail the workflow."
    },
    "router": {
      "type": "object",
      "description": "Settings for the prompt-to-model router that suggests the best LLM for a task based on historical eval data.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Enable model routing suggestions before workflow execution."
        },
        "defaultModel": {
          "type": "string",
          "default": "claude-sonnet-4-5-20250929",
          "description": "Fallback model when insufficient eval data exists for routing."
        },
        "minRecords": {
          "type": "integer",
          "default": 20,
          "minimum": 1,
          "description": "Minimum total eval records required before the router makes suggestions."
        },
        "minModels": {
          "type": "integer",
          "default": 2,
          "minimum": 1,
          "description": "Minimum distinct models with eval data before routing is active."
        },
        "models": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Candidate model IDs the router may recommend. Empty array means all models found in eval data."
        },
        "defaultAgent": {
          "type": "string",
          "default": "claude",
          "description": "Fallback agent CLI when router has insufficient data or no agentMap entry matches the recommended model.",
          "examples": ["claude", "codex"]
        },
        "agentMap": {
          "type": "object",
          "description": "Maps model IDs to agent CLI commands. Used to determine which agent CLI to launch when the router recommends a model.",
          "additionalProperties": {
            "type": "string",
            "description": "Agent CLI command name (e.g. 'claude', 'codex')."
          }
        },
        "mode": {
          "type": "string",
          "enum": ["heuristic", "llm", "auto"],
          "default": "auto",
          "description": "Routing strategy: 'heuristic' uses regex-based classification, 'llm' uses the DSPy-optimized Haiku selector, 'auto' tries LLM first then falls back to heuristic."
        },
        "llmModel": {
          "type": "string",
          "default": "gpt-4o-mini",
          "description": "Model to use for LLM-based routing decisions. Should be fast and cheap."
        },
        "llmProvider": {
          "type": "string",
          "enum": ["openai", "anthropic"],
          "default": "openai",
          "description": "API provider for LLM routing calls. OpenAI recommended (gpt-4o-mini is fast and cheap)."
        }
      }
    },
    "validation": {
      "type": "object",
      "description": "Settings for task packet validation (quality gate after issue expansion).",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Whether validation is enabled. Can be bypassed per-expansion with --skip-validation flag."
        },
        "layer1": {
          "type": "object",
          "description": "Layer 1 deterministic validation (file paths, structure).",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Whether Layer 1 validation is enabled."
            }
          },
          "additionalProperties": false
        },
        "layer2": {
          "type": "object",
          "description": "Layer 2 LLM-based validation (vague specs, contradictions).",
          "properties": {
            "enabled": {
              "type": "boolean",
              "default": true,
              "description": "Whether Layer 2 validation is enabled."
            },
            "model": {
              "type": "string",
              "default": "claude-haiku-4-5-20251001",
              "description": "LLM model to use for task packet review. Should be fast and cheap (Haiku recommended)."
            },
            "provider": {
              "type": "string",
              "enum": ["claude-cli", "anthropic"],
              "default": "claude-cli",
              "description": "LLM provider for Layer 2 validation. 'claude-cli' uses local subscription, 'anthropic' uses API key."
            }
          },
          "additionalProperties": false
        },
        "onFailure": {
          "type": "string",
          "enum": ["conservative", "auto-fix", "proceed"],
          "default": "conservative",
          "description": "Behavior when validation fails: 'conservative' (skip update), 'auto-fix' (retry expansion with feedback), 'proceed' (update anyway with warnings attached)."
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
